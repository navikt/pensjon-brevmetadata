name: NAIS Deploy

on: push

env:
  IMAGE: docker.pkg.github.com/${{ github.repository }}/pensjon-brevdata:${{ github.sha }}
  LATEST_IMAGE: docker.pkg.github.com/${{ github.repository }}/pensjon-brevdata:latest

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup java
        uses: actions/setup-java@v1
        with:
          java-version: '11.x'
      - name: Setup cache
        uses: actions/cache@v1
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: mvn -B package --file pom.xml
      - name: Build Docker image
        run: |
          docker build -t ${IMAGE} .
      - name: Login to Github Package Registry
        env:
          DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$DOCKER_PASSWORD" | docker login --username "$GITHUB_REPOSITORY" --password-stdin docker.pkg.github.com
      - name: Push Docker image
        run: "docker push ${IMAGE}"
      - name: Tag latest docker image
        run: "docker tag ${IMAGE} ${LATEST_IMAGE}"
      - name: Push latest docker image
        run: "docker push ${LATEST_IMAGE}"

  deploy-to-dev-default:
    name: Deploy to dev default
    if: github.ref == 'refs/heads/master'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Deploy to dev-fss default
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: dev-fss
          RESOURCE: nais/nais-dev.yml
          VAR: namespace=default,ingress=https://pensjon-brevdata.nais.preprod.local,unleashurl=https://unleash.nais.adeo.no/api/
      - name: Deploy to dev-sbs
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: dev-sbs
          RESOURCE: nais/nais-dev.yml
          VAR: namespace=default,ingress=https://pensjon-brevdata.nais.oera-q.local,unleashurl=https://unleashproxy.nais.oera.no/api/
      - name: Deploy brevmetadata to dev-fss default
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: dev-fss
          RESOURCE: nais/nais-dev-metadata.yml
          VAR: namespace=default,ingress=https://pensjon-brevmetadata.dev.adeo.no,unleashurl=https://unleash.nais.adeo.no/api/
      - name: Deploy brevmetadata to dev-sbs
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: dev-sbs
          RESOURCE: nais/nais-dev-metadata.yml
          VAR: namespace=pensjonsbrev,ingress=https://pensjon-brevmetadata-pensjonsbrev.dev.nav.no,unleashurl=https://unleashproxy.nais.oera.no/api/

  deploy-to-dev-q4:
    name: Deploy to dev q4
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Deploy to dev-fss q4
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: dev-fss
          RESOURCE: nais/nais-dev.yml
          VAR: namespace=q4,ingress=https://pensjon-brevdata-q4.nais.preprod.local,unleashurl=https://unleash.nais.adeo.no/api/
      - name: Deploy brevmetadata to dev-fss q4
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: dev-fss
          RESOURCE: nais/nais-dev-metadata.yml
          VAR: namespace=q4,ingress=https://pensjon-brevmetadata-q4.dev.adeo.no,unleashurl=https://unleash.nais.adeo.no/api/

  deploy-to-dev-pensjonsbrev:
    name: Deploy to dev pensjonsbrev
    if: github.ref == 'refs/heads/master'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Deploy to dev-fss pensjonsbrev
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: dev-fss
          RESOURCE: nais/nais-dev.yml
          VAR: namespace=pensjonsbrev,ingress=https://pensjon-brevdata-pensjonsbrev.nais.preprod.local,unleashurl=https://unleash.nais.adeo.no/api/
      - name: Deploy brevmetadata to dev-fss pensjonsbrev
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: dev-fss
          RESOURCE: nais/nais-dev-metadata.yml
          VAR: namespace=pensjonsbrev,ingress=https://pensjon-brevmetadata-pensjonsbrev.dev.adeo.no,unleashurl=https://unleash.nais.adeo.no/api/

  deploy-to-prod:
    name: Deploy to prod
    if: github.ref == 'refs/heads/master'
    needs: [deploy-to-dev-default, deploy-to-dev-q4, deploy-to-dev-pensjonsbrev]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Deploy to prod-fss
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: prod-fss
          RESOURCE: nais/nais-prod-fss.yml
      - name: Deploy to prod-sbs
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: prod-sbs
          RESOURCE: nais/nais-prod-sbs.yml
      - name: Deploy brevmetadata to prod-fss
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: prod-fss
          RESOURCE: nais/nais-prod-fss-metadata.yml
      - name: Deploy brevmetadata to prod-sbs
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: prod-sbs
          RESOURCE: nais/nais-prod-sbs-metadata.yml

  deploy-to-dev-gcp:
    name: Deploy to gcp
    if: github.ref == 'refs/heads/master'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Deploy to dev-gcp
        uses: nais/deploy/actions/deploy@v1
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: dev-gcp
          RESOURCE: nais/nais-dev-gcp.yml